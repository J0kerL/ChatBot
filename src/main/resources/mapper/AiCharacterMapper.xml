<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chatbot.mapper.AiCharacterMapper">

    <!-- ResultMap: 处理数据库下划线与 Java 驼峰命名的映射 -->
    <resultMap id="BaseResultMap" type="com.chatbot.model.entity.AiCharacter">
        <!-- id 标签用于主键 -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <!-- result 标签用于普通字段 -->
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="relationship" property="relationship" jdbcType="VARCHAR"/>
        <result column="age" property="age" jdbcType="INTEGER"/>
        <result column="appearance" property="appearance" jdbcType="VARCHAR"/>
        <result column="personality_tags" property="personalityTags" jdbcType="VARCHAR" typeHandler="com.chatbot.common.handler.JsonTypeHandler"/>
        <result column="background" property="background" jdbcType="VARCHAR"/>
        <result column="speaking_style" property="speakingStyle" jdbcType="VARCHAR"/>
        <result column="memory_settings" property="memorySettings" jdbcType="VARCHAR"/>
        <result column="avatar" property="avatar" jdbcType="VARCHAR"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 插入: 返回自增主键 -->
    <insert id="insert" parameterType="com.chatbot.model.dto.AiCharacterDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ai_character (user_id, name, relationship, age, appearance, personality_tags, background,
                                  speaking_style, memory_settings, avatar, created_at)
        VALUES (#{userId}, #{name}, #{relationship}, #{age}, #{appearance},
                #{personalityTags, typeHandler=com.chatbot.common.handler.JsonTypeHandler}, #{background},
                #{speakingStyle}, #{memorySettings}, #{avatar}, #{createdAt})
    </insert>

    <select id="query" resultType="com.chatbot.model.entity.AiCharacter">
        SELECT *
        FROM ai_character
        <where>
            <if test="name != null and name != ''">
                and name like concat('%',#{name},'%')
            </if>
        </where>
        ORDER BY id ASC
    </select>

    <!-- 动态更新AI角色信息 -->
    <update id="updateSelective" parameterType="com.chatbot.model.dto.UpdateAiCharacterDTO">
        UPDATE ai_character
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="relationship != null and relationship != ''">
                relationship = #{relationship},
            </if>
            <if test="age != null">
                age = #{age},
            </if>
            <if test="appearance != null and appearance != ''">
                appearance = #{appearance},
            </if>
            <if test="personalityTags != null">
                personality_tags = #{personalityTags, typeHandler=com.chatbot.common.handler.JsonTypeHandler},
            </if>
            <if test="background != null and background != ''">
                background = #{background},
            </if>
            <if test="speakingStyle != null and speakingStyle != ''">
                speaking_style = #{speakingStyle},
            </if>
            <if test="memorySettings != null and memorySettings != ''">
                memory_settings = #{memorySettings},
            </if>
            <if test="avatar != null and avatar != ''">
                avatar = #{avatar},
            </if>
        </set>
        WHERE id = #{id}
    </update>
</mapper>